%% LyX 2.0.2 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[english]{article}
\usepackage{lmodern}
\renewcommand{\ttdefault}{lmodern}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{listings}
\usepackage{geometry}
\geometry{verbose,tmargin=2cm,bmargin=2cm,lmargin=2cm,rmargin=2cm}
\usepackage{color}
\usepackage{float}

\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% User specified LaTeX commands.
\@ifundefined{definecolor}
 {\usepackage{color}}{}
\usepackage{babel}

\makeatother

\begin{document}

\title{\textbf{NNPDF++ General Overview}}


\author{S. Carrazza$^{1}$ for the NNPDF Collaboration\\
 {\small $^{1}$University of Milan}}
\maketitle
\begin{abstract}
This report presents the NNPDF++ project and objectives. It provides
the C++ code convention that must be used by every NNPDF++ developer,
in order to have a clear and optimized code, avoiding potential bugs
in the code. The rules covers two aspects of programming: the style
of code and the rules to check memory leaks before submit the changes
to subversion. We also present the new NNPDF++ structure and projects. 
\end{abstract}
\tableofcontents{}

\newpage{}


\section{Introduction}

From the development of NNPDF in Fortran we learned important concepts
about the design of computation software. Even if the Fortran language
is simple and intuitive for the development of scientific software,
today it is no longer competitive with the new object-oriented languages
like C++.


\subsection{Motivation}

The object-oriented languages provides advantages like: 
\begin{description}
\item [{\emph{(a)}}] the encapsulation of data attributes inside classes,
eliminating the global variables (common blocks) which are difficult
to track during the execution of a program, incrementing the probability
to introduce bugs and reducing the readability of code. 
\item [{\emph{(b)}}] the modularity and flexibility of code, which can
be reused easily by multiple projects, generalizing algorithms and
avoiding redundant code. 
\end{description}
On the other hand, from the point of view of performance, C++ provides: 
\begin{description}
\item [{\emph{(i)}}] fast and dynamic execution code, with C++ we have
the control of memory allocation and management. 
\item [{\emph{(ii)}}] easy interface to introduce specialized algorithms
provided by libraries such as LAPACKPP, BLAS and GSL. 
\item [{\emph{(iii)}}] easy implementation of parallel computations with
GPU and CPU technologies such as i.e. NVIDIA CUDA, OpenCL for GPU,
and OpenMP for CPU. 
\end{description}

\section{Code convention}


\subsection{Code location}

The NNPDF++ project is hosted at University of Edinburgh under revision
control. To checkout the repository do

\begin{lstlisting}
svn co https://svn.ecdf.ed.ac.uk/repo/ph/nnpdfcpp/trunk/nnpdfcpp nnpdfcpp
svn co https://svn.ecdf.ed.ac.uk/repo/ph/nnpdfcpp/trunk/data data
\end{lstlisting}



\subsection{Building the project}

To build the full project just do

\begin{lstlisting}
cd nnpdfcpp
./configure (verifies the dependencies)
\end{lstlisting}
If all dependencies are satisfied, you'll see a message explaining
the available options in the Makefile, like

\begin{lstlisting}
make install (build everything doc|gui|src)
make or make release (build src in release mode)
make debug (build src in debug mode, binary name suffix _d)
make doc (build doxygen documentation)
make qtgui (build nnpdfwizard gui program)
make uninstall (cleanup everything)
make clean (cleanup src|doc)
make cleangui (cleanup gui)
\end{lstlisting}



\subsection{Documentation}

The documentation of NNPDF++ must be compatible with Doxygen syntax.
With Doxygen the final result is very simple to read and understand,
everybody is invited to make an effort in the documentation tasks.
After doing

\begin{lstlisting}
make doc
firefox doc/doxygen/html/index.html
\end{lstlisting}
you will be able to browse the code by using your favorite web browser.


\subsection{Compiling the code}

By default we establishe\textcolor{black}{d} that the code should
be compiled using the following flags: 
\begin{itemize}
\item In the release mode, code is compiled by using


\begin{lstlisting}
CFLAGS = -Wall -O3 
\end{lstlisting}


\item However for debug mode, the compiler options are


\begin{lstlisting}
CFLAGS = -Wall -O0 -g 
\end{lstlisting}


\end{itemize}
Before the submission of code to subversion or to clusters, developers
must search for possible memory leaks in its program, by running VALGRIND
software. VALGRIND debugs code searching for memory leaks and in general
a code that passes VALGRIND test has a high level of optimization.

To use VALGRIND, we first compile the project in debug mode and then
run

\begin{lstlisting}
valgrind --leak-check=yes ./mainprogramname_d
\end{lstlisting}
which outputs the errors in the code. You are invited to solve the
issues before submit the code.

To suppress errors coming from 3th part libraries such as LHAPDF and
ROOT, you should create a suppression file following the instructions
at

\begin{lstlisting}
svn co https://svn.ecdf.ed.ac.uk/repo/ph/nnpdfcpp/branches/carrazza
\end{lstlisting}



\section{NNPDF++ structure}


\subsection{Settings}

In order to avoid the creation of multiple configuration par files
which contains configuration settings for NNPDF, we decided to create
a class which is responsible for parsing the options from a single
and unique configuration INI file. Here an example of such file syntax,
a real example is located in config/config.ini

\begin{lstlisting}
#
# Configuration file for NNPDF++,
# comments start with # or ; or [
#

[Description]
This is the description block, 
please update these lines before run.
[/Description]
################################################################
[Experiments & Datasets]
EXPERIMENT: NMCPD
	DATASET = NMCPD 0.5
EXPERIMENT: NMC
 	DATASET = NMC 0.5
EXPERIMENT: SLAC
 	DATASET = SLACP 0.5
 	DATASET = SLACD 0.5
EXPERIMENT: BCDMS
 	DATASET = BCDMSP 0.5
 	DATASET = BCDMSD 0.5
EXPERIMENT: HERA1AV
 	DATASET = HERA1NCEP 0.5
 	DATASET = HERA1NCEM 0.5
 	DATASET = HERA1CCEP 0.5
 	DATASET = HERA1CCEM 0.5
EXPERIMENT: CHORUS
 	DATASET = CHORUSNU 0.5
 	DATASET = CHORUSNB 0.5
EXPERIMENT: FLH108
 	DATASET = FLH108 1.0
EXPERIMENT: NTVDMN
 	DATASET = NTVNUDMN 0.5
 	DATASET = NTVNBDMN 0.5
EXPERIMENT: ZEUSH2
 	DATASET = Z06NC 0.5
 	DATASET = Z06CC 0.5
EXPERIMENT: ZEUSF2C
	DATASET = ZEUSF2C99 0.5
 	DATASET = ZEUSF2C03 0.5
 	DATASET = ZEUSF2C08 0.5
 	DATASET = ZEUSF2C09 0.5
EXPERIMENT: H1F2C
 	DATASET = H1F2C01 0.5
 	DATASET = H1F2C09 0.5
 	DATASET = H1F2C10 0.5
EXPERIMENT: DYE886
 	DATASET = DYE886R 1.0
	DATASET = DYE886P 0.5
EXPERIMENT: DYE605
	DATASET = DYE605 0.5
EXPERIMENT: CDFWASY
	DATASET = CDFWASYM 1.0
EXPERIMENT: CDFZRAP
	DATASET = CDFZRAP 1.0
EXPERIMENT: D0ZRAP
	DATASET = D0ZRAP 1.0
EXPERIMENT: ATLASWZRAP
	DATASET = ATLASWZRAP36PB 1.0
EXPERIMENT: D0R2CON
	DATASET = D0R2CON 0.5
EXPERIMENT: CDFR2KT
	DATASET = CDFR2KT 0.5
EXPERIMENT: ATLASR04JETS
	DATASET = ATLASR04JETS36PB 0.5
EXPERIMENT: CMSWEASY
	DATASET = CMSWEASY840PB 1.0
EXPERIMENT: LHCBWZ
	DATASET = LHCBWZ36PB 1.0
[/Experiments & Datasets]

################################################################
[Experimental Data]
T0PDFSET = NNPDF-t0-set-nlo     # PDF set to generate t0 covariance matrix
IQ2CUT   = 0			# Q2 cuts, see Filters::ApplyKinCuts() 
NPARSAT  = 2                    # number of parameters, see Filters::Q2CUTSAT()
PARSAT   = 1.5 			
	   0.333333             # array of NPARSAT elements
IREG     = 1			# Q2 cut modality
Q2MINCUT = 3.0			# Q2 minimum cut
Q2MIN    = 3.0			# Q2 minimum
W2MIN    = 12.5			# W2 minimum
[/Experimental Data]

################################################################
[ClosureTest]
FAKEDATA    = 0
FAKEPDF  = NNPDF23_nlo_as_0119
[/ClosureTest]

################################################################
[Theory]
PTORD    = 1                    # 0 for LO, 1 for NLO, 2 NNLO
ALPHAS   = 119			# Alpha_s(Mz)
Q20      = 2.0	                # the initial scale
VFNS     = GMVN                 # VFNS (FFN0, FFNS, ZMVN, GMVN)
VFNSTYPE = A                    # FONLL (A,B or C), only for GMVN
QED      = 0
NFL      = 7			# number of flavours (7, 8, 9, 13)
[/Theory]

################################################################
[Replica Properties]
SEED	     = 0                # set the seed for the random generator
GENREP       = 1		# 1 generate MC replicas, 0 use real data
RNGALGORITHM = 0		# 0 = ranlux, 1 = cmrg, see randomgenerator.cc
[/Replica Properties]

################################################################
[Fitting]
FITMETHOD  = GA                 # Minimization algorithm 
NGEN       = 50000		# Maximum number of generations
NMUTANTS   = 80			# Number of mutants for replica
NMUTPDF    = 2 2 2 2 2 2 2      # Number of mutations per PDF
MUTSIZESNG = 5    0.5
MUTPROBSNG = 0.5  0.5
MUTSIZEGLU = 5    0.5
MUTPROBGLU = 0.5  0.5
MUTSIZET3  = 5    0.5
MUTPROBT3  = 0.5  0.5
MUTSIZEV   = 5    0.5
MUTPROBV   = 0.5  0.5
MUTSIZEDS  = 5    0.5
MUTPROBDS  = 0.5  0.5
MUTSIZESP  = 5    0.5
MUTPROBSP  = 0.5  0.5
MUTSIZESM  = 5    0.5
MUTPROBSM  = 0.5  0.5
[/Fitting]

################################################################
[Stopping]
DYNSTOP    = 1 			# 1 = activate dynamic stopping
STOPMETHOD = TRVAL              # Stopping method
MINCHI2    = 6.0		# Minimum chi2 for experiments
NSMEAR     = 200		# Smear for stopping
DELTASM    = 200		# Delta smear for stopping
RV         = 1.0003		# Ratio for validation stopping
RT         = 0.9999		# Ratio for training stopping
[/Stopping]

################################################################
[Positivity]
POSMULT    = 10E10		# Positivity Lagrange Multiplier
POSDATASET = FCPOS
POSDATASET = FLPOS
POSDATASET = DMPOS
[/Positivity]

################################################################
[NN Properties]
PARAMTYPE = NN
NLAYERS   = 4			# Total number of layers
NNODES    = 2 5 3 1		# Number of nodes per layer
SMALLXSNG = 1.05 1.35		# Small x exponents for singlet 
LARGEXSNG = 2.55 3.45		# Large x exponents for singlet
SMALLXGLU = 1.05 1.35		# Small x exponents for gluon
LARGEXGLU = 3.55 4.45		# Large x exponents for gluon
SMALLXT3  = 0.00 0.50 		# Small x exponents for T3
LARGEXT3  = 2.55 3.45		# Large x exponents for T3
SMALLXV	  = 0.00 0.50		# Small x exponents for V
LARGEXV	  = 2.55 3.45		# Large x exponents for V
SMALLXDS  = -0.95 -0.65		# Small x exponents for DeltaS
LARGEXDS  = 12.0 14.0		# Large x exponents for DeltaS
SMALLXSP  = 1.05 1.35		# Small x exponents for s+
LARGEXSP  = 2.55 3.45		# Large x exponents for s+
SMALLXSM  = 0.00 0.50		# Small x exponents for s-
LARGEXSM  = 2.55 3.45		# Large x exponents for s-
[/NN Properties]

################################################################
[Ouput Folder]
RESULTSDIR = results		# Relative to main folder
[/Ouput Folder]

################################################################
[Devel]
DEBUG    = 0
[/Devel]
\end{lstlisting}

The to access the variables interactively just create an instance
of NNPDFSettings class and get the elements that you need. Where an
example

\begin{lstlisting}{[}language={C++}{]} \#include <iostream>
int main() { 
  NNPDFSettings s(``config.ini'');
  int ptOrder = s.GetPTORD();

  return 0; 
} 
\end{lstlisting}


\subsection{Projects}

The current NNPDF++ is composed by the following projects:
\begin{itemize}
\item buildmaster: which converts data provided by articles in the common data
\item validphys: which compares data results with theoretical predictions
\item filter: apply kincuts and build covmat and invcovmat (t0 and experimental for validphys and nnfit)
\item nnfit: performs the fit for 1 replica
\item chi2check: compute the chi2 for a LHgrid
\item evolcheck: debug evolution code
\item mkthprediction: print theoretical predictions
\item plotpdf: build a report with only pdf plots
\item tconvcheck: compute the convolution time for thpredictions
\item postfit: create the LHgrid after running nnfit
\item fitmanager: download and upload fits to the nnpdfserver (fit sharing) 
format
\end{itemize}

\include{buildmaster}

\include{filter}

\include{validphys}

\include{plotpdf}

%\include{nnfit}

\end{document}
