\documentclass[11pt]{article}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\usepackage{amsmath,amsfonts,amssymb}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage[numbers, sort]{natbib}
\usepackage{hyperref}
\geometry{letterpaper}                   % ... or a4paper or a5paper or ... 
%\geometry{landscape}                % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{epstopdf}
\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}

\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\ba}{\begin{eqnarray}}
\newcommand{\ea}{\end{eqnarray}}

\newcommand{\ns}{\normalsize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%
% abbreviate Greek
\newcommand{\ax}{\alpha}
\newcommand{\bx}{\beta}
\newcommand{\cx}{\gamma}
\newcommand{\dx}{\delta}
\newcommand{\ox}{\omega}
\newcommand{\lx}{\lambda}
\newcommand{\gx}{\gamma}
\newcommand{\ab}{\bar\alpha}
\newcommand{\bb}{\bar\beta}
\newcommand{\cb}{\bar\gamma}
\newcommand{\db}{\bar\delta}
\newcommand{\Sx}{\Sigma}
\newcommand{\Lx}{\Lambda}
\newcommand{\Ox}{\Omega}
\newcommand{\Dx}{\Delta}
\newcommand{\Gx}{\Gamma}
\newcommand{\te}{\tilde \epsilon}
\newcommand{\tm}{\tilde \mu}
\newcommand{\tmu}{\tilde \mu}

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%
% Cal
\newcommand{\cC}{\mathcal{C}}
\newcommand{\cD}{\mathcal{D}}
\newcommand{\cL}{\mathcal{L}}
\newcommand{\cK}{\mathcal{K}}
\newcommand{\cN}{\mathcal{N}}
\newcommand{\cG}{\mathcal{G}}
\newcommand{\cA}{\mathcal{A}}
\newcommand{\cF}{\mathcal{F}}
\newcommand{\cH}{\mathcal{H}}
\newcommand{\cI}{\mathcal{I}}
\newcommand{\cR}{\mathcal{R}}
\newcommand{\cQ}{\mathcal{Q}}
\newcommand{\cM}{\mathcal M}
\newcommand{\W}{\mathcal W}
\newcommand{\V}{\mathcal V}
\def\Im{\,{\rm Im}\, }
\def\Re{\,{\rm Re}\, }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%

\title{\tt{nnpdf++} data layout}
\author{Maintainer: Nathan Hartland\\ {\it nathan.hartland@physics.ox.ax.uk }}
\begin{document}
\maketitle
\tableofcontents
\clearpage
\section{Revision history}

\begin{table}[htp]
\begin{center}
\begin{tabular}{|c|c|c|c|p{50mm}|}
\hline
Date & Version & Major/Minor & Author & Comments\\
\hline\hline
9/9/15 & 1.0.0 & - & nh & First version\\
\hline
16/9/15 & 1.1.0 & Major & vb/sc/nh & Implementing many \newline new theory parameters. \newline Adding header to {\tt CFACTOR} files.\\
\hline
\end{tabular}
\end{center}
\label{tab:revsum}
\end{table}%

\clearpage

\section{Introduction}

In the {\tt nnpdf++} project, data files used by the code may be grouped into two categories, theory and experiment. Experimental data and the information pertaining to the treatment of systematic errors are held in {\tt CommonData} and {\tt SYSTYPE} files. {\tt FK} tables, {\tt COMPOUND} and {\tt CFACTOR} files store the precomputed information for use when calculating theoretical predictions corresponding to information held in the equivalent {\tt CommonData} file. In this document the file formats and naming conventions for these files will be detailed, along with the directory structure employed by the {\tt nnpdf++} code.

For NNPDF3.1 and later fits, a considerably larger number of theory options will be explored than in previous determinations. In NNPDF3.0 the main theory variations used were perturbative order, value of the strong coupling and the number of active flavours in the VFNS. For NNPDF3.1 and later, variations in additional parameters must be accommodated, such as treatments of the heavy quark mass (pole vs $\overline{\mathrm{MS}}$), scale variations,  intrinsic charm, resummation effects etc. The book-keeping used to enable efficient variations of the theoretical treatment used in fits post-3.0 will therefore also be outlined here.

This document will begin by detailing the specifications for the file formats used by the code, first with the experimental data file formats and layouts in Section~\ref{sec:experimental} and secondly with the file formats used for theoretical predictions in Section~\ref{sec:theory}. Finally the organisation of these files within the {\tt nnpdf++} structure will be described in Section~\ref{sec:org}.

\subsection{Important definitions}
In order to clarify the later description, here are a few important terminological points to note.

\subsubsection*{\emph{Dataset} vs \emph{Experiment}}
When referring to a collection of data points two words are used in the {\tt nnpdf++} code which have specific meanings.
\emph{Dataset} refers to the result of a specific measurement, typically associated with a single experimental paper and corresponds to the {\tt DataSet} class in the {\tt nnpdf++} code. \emph{Experiment} refers
to a collection of \emph{Datasets} which are associated by experimental cross-correlations. For example, the ATLAS 2010 $R=0.4$ inclusive jet measurement~\cite{Aad:2011fc}
and the ATLAS high-mass Drell-Yan measurement of~\cite{Aad:2013iua} are both examples of \emph{Datasets} as used in the NNPDF3.0 analysis. Both of these datasets are
grouped into the ATLAS \emph{Experiment} as they have systematic uncertainties that are cross-correlated with each other. In this document, when using these terms in
this sense, they will be italicised for clarity.

\subsubsection*{\emph{Dataset} and \emph{Experiment} names}
When referred to, the \emph{Dataset} and \emph{Experiment} names refer to the short identifying string used in the code for each \emph{Dataset} and \emph{Experiment}.
For example, the \emph{Dataset} name for the aforementioned ATLAS 2010 inclusive jet measurement with $R=0.4$ is \mbox{ATLASR04JETS36PB}.

\section{Experimental data files}\label{sec:experimental}
Data made available by experimental collaborations comes in a variety of formats. For use in a fitting code, this data must be converted into a common format
that contains all the required information for use in PDF fitting. Existing formats commonly used by the community, such as in HepData, are generally unsuitable.
Principally as they often do not fully describe the breakdown of systematic uncertainties. Therefore over several years an NNPDF standard data format has been
iteratively developed, now denoted {\tt CommonData}. In addition to the {\tt CommonData} files themselves, in the {\tt nnpdf++} project the user has the ability to vary
the treatment of individual systematic errors by use of parameter files denoted {\tt SYSTYPE} files. In this section we shall detail the specifications of these two files.

In principle, the file specification and classes described in this section are independent of the {\tt nnpdf++} project and may be generated by whatever means the user sees fit.
In practice, the {\tt CommonData} and {\tt SYSTYPE} files are generated by the {\tt buildmaster} project of {\tt nnpdf++} from the raw experimental data files.

\subsection{Process types and kinematics}
Before going into the file formats, we shall summarise the identifying features used for data in the {\tt nnpdf++} code. 

Each datapoint has an associated \emph{process type} string. This can be specified by the user, but \textbf{must} begin with one of a selection of identifying base process types. Additionally for each datapoint three kinematic values are given, the \emph{process type} being primarily to identify the nature of these values. Typically the first kinematic variable is the principal differential quantity used in the measurement. The second kinematic variable is typically the scale of the process. The third is generally the centre-of-mass energy of the process, or inelasticity in the case of DIS. The allowed basic process types, and their corresponding three kinematic variables are outlined below.

\begin{itemize}
\item \textbf{DIS} - Deep inelastic scattering measurements: $(x,Q^2,y)$
\item \textbf{DYP} - Fixed-target Drell-Yan measurements: $(y,M^2,\sqrt{s})$
\item \textbf{EWK} - Collider electroweak production: $(\eta,M^2,\sqrt{s})$
\item \textbf{JET} - Jet production: $(\eta,p_T,\sqrt{s})$
\item \textbf{HQP} - Heavy quark production: $(y,p_T,\sqrt{s})$
\item \textbf{INC} - A total inclusive cross-section: $(0,0,0)$
\end{itemize}

As examples of \emph{process type} strings, consider \textbf{EWK\_WASYM} for a collider $W$ boson asymmetry measurement, and \textbf{DIS\_F2P} for the $F_2^p$ structure function in DIS. The user is free to choose something identifying for the second  segment of the process type, the important feature being the first three characters.

\subsubsection*{Notes for the future}
In the future it would be nice to have a more flexible treatment of the kinematic variables, both in their number and labelling.


\subsection{{\tt CommonData} file format}
Each experimental \emph{Dataset} has its own {\tt CommonData} file. {\tt CommonData} files contain the bulk of the experimental information used in the {\tt nnpdf++} project, with the only other experimental data files controlling the treatment and correlation of systematic errors. Each {\tt CommonData} file is a plaintext file with the following layout.

The first line begins with the \emph{Dataset} name, the number of systematic errors, and the number of datapoints in the set, whitespace separated.
For example for the ATLAS 2010 jet measurement the first line of the file reads:
\begin{quotation}\noindent
ATLASR04JETS36PB        91      90
\end{quotation}
Which demonstrates that the set \emph{name} is `ATLASR04JETS36PB', that there are 91 sources of systematic uncertainty, 90 datapoints, one associated {\tt FK} table, and that the {\tt FK} table corresponds to a proton initial state. As another example, consider the NMCPD \emph{Dataset}:
\begin{quotation}\noindent
NMCPD   5       211
\end{quotation}
Here there are 5 sources of systematic uncertainty and 211 datapoints.

Following this, each line specifies the details of a single datapoint. The first value being the datapoint index $1< i_{\text{dat}} \leq N_{\mathrm{dat}}$, followed by the \emph{process type} string as outlined above, and the three kinematic variables in order. These are followed by the value of the experimental datapoint itself, and the value of the statistical uncertainty associated with it (absolute value). Finally the systematic uncertainties are specified. The layout per datapoint is therefore
\begin{quotation}\noindent
$i_{\mathrm{dat}}$   \emph{ProcessType} kin$_1$ kin$_2$ kin$_3$ data\_value stat\_error  $[..$ systematics $..]$ 
\end{quotation}
For example, in the case of a DIS datapoint from the BCDMSD \emph{Dataset}:
\begin{quotation}\noindent
1    DIS\_F2D 7.0e-02   8.75e+00   5.666e-01   3.6575e-01   6.43e-03 $[..$ systematics $..]$ 
\end{quotation}
In these lines the systematic uncertainties are laid out as so. For each uncertainty, additive and multiplicative versions are given. The additive uncertainty is given by absolute value, and the multiplicative as a percentage of the data value. The systematics string is formed by the sequence of $N_{\text{sys}}$ pairs of systematic uncertainties:
%%
\begin{quotation}\noindent
$[..$ systematics $..] =  \sigma^{\mathrm{add}}_0 \quad  \sigma^{\mathrm{mul}}_0\quad \sigma^{\mathrm{add}}_1 \quad \sigma^{\mathrm{mul}}_1 \quad....\quad \sigma^{\mathrm{add}}_n  \quad\sigma^{\mathrm{mul}}_n$
\end{quotation}
%%
where $\sigma^{\mathrm{add}}_i$ and $\sigma^{\mathrm{mul}}_i$ are the additive and multiplicative versions respectively of the systematic uncertainty arising from the $i$th source. While it may seem at first that the multiplicative error is spurious given the presence of the additive error and data central value, this may not be the case. For example in a closure test scenario, the data central values may have been replaced in the {\tt CommonData} file by theoretical predictions. Therefore if you wish to use a covariance matrix generated with the original multiplicative uncertainties via the $t_0$ method, you must also store the original multiplicative (percentage) error. For flexibility and ease of I/O this is therefore done in the {\tt CommonData} file itself

For a \emph{Dataset} with $N_{\text{dat}}$ datapoints and $N_{\text{sys}}$ sources of systematic uncertainty, the total {\tt CommonData} file should therefore be $N_{\text{dat}}+1$ lines long. Its first line contains the set parameters, and every subsequent line should consist of the description of a single datapoint. Each datapoint line should therefore contain $7 + 2N_{\text{sys}}$ columns.

\subsection{{\tt SYSTYPE} file format}
The explicit presentation of the systematic uncertainties in the {\tt CommonData} file allows for a great deal of flexibility in the treatment of these errors. Specifically, whether they should be treated as additive or multiplicative uncertainties, and how they are correlated, both within the \emph{Dataset} and within a larger \emph{Experiment}. A specification for how the systematic uncertainties should be treated is provided by a {\tt SYSTYPE} file. As there is not always an unambiguous method for the treatment of these uncertainties, these information is kept outside the (unambiguous) {\tt CommonData} file. Several options for this treatment are often provided in the form of multiple {\tt SYSTYPE} files which may be selected between in the fit.

Each {\tt SYSTYPE} file begins with a line specifying the total number of systematics. Naturally this must match with the $N_{\text{sys}}$ variable specified in the associated {\tt CommonData} file. This is presented as a simple number. For example, in the case of the BCDMSD {\tt SYSTYPE} files, the first line is
%%
\begin{quotation}\noindent
8
\end{quotation}
%%
As there are $N_{\text{sys}}=8$ sources of systematic uncertainty for this \emph{Dataset}. Following this line are $N_{\text{sys}}$ lines, describing each source of systematic uncertainty. For each source two parameters are provided, the \emph{uncertainty treatment} and the \emph{uncertainty description}. These are laid out for each systematic as:
%%
\begin{quotation}\noindent
$i_{\text{sys}}$\quad $[$\emph{uncertainty treatment}$]$\quad $[$\emph{uncertainty description}$]$
\end{quotation}
%%
Where $1< i_{\text{sys}} \leq N_{\mathrm{sys}}$ enumerates each systematic. The \emph{uncertainty treatment} determines whether the uncertainty should be treated as additive, multiplicative, or in cases where the choice is unclear, as randomised on a replica by replica basis. These choices are selected by using the strings \textbf{ADD}, \textbf{MULT}, or \textbf{RAND}. The \emph{uncertainty description} specifies how the systematic is to be correlated with other datapoints. There are two special cases for the \emph{uncertainty description}, specified by the strings \textbf{CORR} and \textbf{UNCORR}. These two specify whether the systematic is fully correlated \textbf{only} within the \emph{Dataset} (\textbf{CORR}), or whether the systematic is totally uncorrelated (\textbf{UNCORR}). If the user wishes to correlate a specific uncertainty between multiple \emph{Datasets} within an \emph{Experiment}, then they should use a custom \emph{uncertainty description}. When building a covariance matrix for an \emph{Experiment}, the {\tt nnpdf++} code checks for matches between the \emph{uncertainty descriptions} of systematics of its constituent \emph{Datasets}. If a match is found, the code will correlate those systematics over the relevant datasets.

As an example, let us consider an NNPDF2.3 standard {\tt SYSTYPE} for the BCDMSD \emph{Dataset}.
%%
\begin{quotation}\noindent
8\\
1    ADD    BCDMSFB\\
2    ADD    BCDMSFS\\
3    ADD    BCDMSFR\\
4    MULT    BCDMSNORM\\
5    MULT    BCDMSRELNORMTARGET\\
6    MULT    CORR\\
7    MULT    CORR\\
8    MULT    CORR
\end{quotation}
%%
Here the first five systematics have custom \emph{uncertainty descriptions}, thereby allowing them to be cross-correlated with other \emph{Datasets} in a larger \emph{Experiment}. Systematics six to eight are specified as being fully correlated, but only within the BCDMSD  \emph{Dataset}. Additionally note that the first three systematics are specified as additive, and the remainder are multiplicative. If we compare now to the equivalent {\tt SYSTYPE} file for the BCDMSP \emph{Dataset}:
%%
\begin{quotation}\noindent
11\\
1    ADD    BCDMSFB\\
2    ADD    BCDMSFS\\
3    ADD    BCDMSFR\\
4    MULT    BCDMSNORM\\
5    MULT    BCDMSRELNORMTARGET\\
6    MULT    CORR\\
7    MULT    CORR\\
8    MULT    CORR\\
9    MULT    CORR\\
10    MULT    CORR\\
11    MULT    CORR
\end{quotation}
It is clear that the first five systematics are the same as in the BCDMSD \emph{Dataset}, and therefore should the two sets be combined into a common \emph{Experiment}, the code will cross-correlate them appropriately. The combination of {\tt SYSTYPE} and {\tt CommonData} is quite flexible. As stated previously, once generated from the original raw experimental data, the {\tt CommonData} file is fixed and should not be altered apart from for the purpose of correcting errors. In practice the full details on the systematic correlation and their treatment is often not precisely specified. This system allows for the safe variation of these parameters for testing purposes.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theory data files} \label{sec:theory}
In the {\tt nnpdf++} project, {\tt FK} tables (or grids) are used to provide the information required to compute pQCD cross sections in a compact fashion.
With the {\tt FK} method a typical hadronic observable datapoint $\mathcal{O}$, is computed as,
\be \mathcal{O}_d= \sum_{\alpha,\beta}^{N_x}\sum_{i,j}^{N_{\mathrm{pdf}}} \sigma^{(d)}_{\alpha\beta i j}N_i^0(x_\alpha)N_j^0(x_\beta). \label{eq:FKprod}\ee
Where $\sigma_{\alpha\beta i j}^{(d)}$, the {\tt FK} table, is a five index object with two indices in flavour ($i$, $j$), two indices in $x$ ($\alpha$, $\beta$) and a datapoint index $d$. $N^0_i({x_\alpha})$ is the $i^{\mathrm{th}}$ initial scale PDF in the evolution basis at x-grid point $x=x_\alpha$. Each {\tt FK} table has an internally specified $x$-grid upon which the PDFs are interpolated.
The full 14-PDF evolution basis used in the {\tt FK} tables is given by :
\be \left\{ \gamma, \Sigma,g,V,V3,V8,V15,V24,V35,T3,T8,T15,T24,T35\right\}. \label{eq:evolbasis} \ee
Additional information may be introduced via correction factors known internally as $C$-factors. These consist of datapoint by datapoint multiplicative corrections to the final result of the {\tt FK} convolution $\mathcal{O}$. These are provided by {\tt CFACTOR} files, typical applications being the application of NNLO and electroweak corrections.
For processes which depend nonlinearly upon PDFs, such as cross-section ratios or asymmetries, multiple FK tables may be required for one observable. In this case information is provided in the form of a {\tt COMPOUND} file which specifies how the results from several {\tt FK} tables may be combined to produce the target observable.
In this section we shall specify the layout of the {\tt FK}, {\tt COMPOUND} and {\tt CFACTOR} files.
\subsection{{\tt FK} file format}
\subsubsection*{{\tt FK} preamble layout}
The first entry in the file consists of a small description of the {\tt FK} grid. This must be exactly three lines long, and at least contain the name of the \emph{Dataset}. Other than this, the user is free to populate this at will, the description will typically be shown as a banner whenever the FK table is opened. For example the CDFR2KT grid description is:
\begin{quotation}\noindent
 -----------------------------------------------------------\\
 FK\_CDFR2KT.dat\\
 -----------------------------------------------------------\\
\end{quotation}
This is followed by the number of data points in the grid and number of $x$-points in the interpolation grid. Like most parameters this is given as a single descriptive header line followed by the actual parameters. An example with $N_{\text{dat}}=76$, $N_{\text{x}}=50$ would be laid out as:
\begin{quotation}\noindent
"ndata nx"\\
76  50
\end{quotation}
Next comes information on whether or not the grid represents a hadronic or DIS observable, and its perturbative order. In the case of hadronic data, the string `\textbf{HAD}' is used as the parameter, while for DIS the parameter is naturally `\textbf{DIS}'. As an example, 
\begin{quotation}\noindent
"hadronic ptord"\\
HAD N2LO
\end{quotation}
Where perturbative order is given as: 0-LO 1-NLO 2-NNLO. This example is therefore for NNLO hadronic data. The next block describes the flavour structure
of the grid by means of a flavour map. This map details which flavour channels are active in the grid, using the basis specified in Eqn.~\ref{eq:evolbasis}. For DIS processes, an example section would be
\begin{quotation}\noindent
 "flavourmap"\\
            0           1           1           0           0           0           0           0           0           0           1           0           0           0 
\end{quotation}
Which specifies that only the Singlet, gluon and $T_8$ channels are populated in the grid. In the case of hadronic FK tables, the full $14\times 14$ flavour combination matrix is specified in the same manner. Consider the flavourmap for the CDFR2KT \emph{Dataset}:
\begin{quotation}\noindent
"flavourmap"\\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 1 1 0 0 0 0 0 0 0 0 0 0 0 \\
0 1 1 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 1 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 1 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 1 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 1 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 1 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0
\end{quotation}
This flavourmap contains 9 nonzero entries, demonstrating the importance of only computing those flavour combinations that are relevant to the process. Additionally this map instructs the {\tt nnpdf++} convolution code as to which elements of the FastKernel grid should be read, to minimise holding zero entries in memory.\\\\
Next we have a line describing the initial scale at which the evolution in the FK grid is performed from:
\begin{quotation}\noindent
"q0"\\
1.0
\end{quotation}
In this case the initial scale PDFs $N^0(x)$ are taken at $Q^2=1$ GeV. The next few lines describe further details of the evolution kernel in the FK grid. Firstly, a string describing the method of PDF evolution.
\begin{quotation}\noindent
"FNS Modev NF"\\
FONLL-C  TRN 5
\end{quotation}
Here we are using the FONNL-C VFNS, with truncated evolution up to a maximum of $n_f=5$ active flavours. For the FNS parameter, the currently permitted values are: \textbf{FFNS} for the fixed-flavour number scheme, \textbf{ZMVFN} for the zero-mass scheme, \textbf{FONLL-A/B/C} for variants of the FONLL general mass scheme. For the Modev parameter, \textbf{TRN} for truncated solution, \textbf{ITE} for iterated solution of the evolution equations.

 This is followed by the value of $\alpha_{S}$ and the reference scale at which it was evaluated (typically $M_Z$):
\begin{quotation}\noindent
"alphas qref"\\
0.118  91.2
\end{quotation}

The details of the heavy quark masses used in the evolution are now specified, for example
\begin{quotation}\noindent
"mass mc, mb, mt"\\
POLE  1.275  4.18  173.07
\end{quotation}
Where the \emph{mass} parameter can take the values \textbf{POLE} when using the heavy quark pole masses, and \textbf{MSBAR} when using $\overline{\text{MS}}$ masses. The \emph{mc}, \emph{mb}, \emph{mt} parameters control the charm, bottom and top masses respectively.
 
 The final theory parameters specified directly in the {\tt FK} table preamble control whether QED corrections are present, the value of $\alpha_{\text{QED}}$, and it's associated reference scale. Typically this is switched off as so:
 \begin{quotation}\noindent
 "QED alphaqed qref"\\
 OFF 0 0 
 \end{quotation}
 When required, the \emph{QED} parameter should be set to \textbf{ON} and the \emph{alphaqed} and \emph{qref} parameters filled.

The final section of the preamble before the grid itself defines the $x$ grid upon which the {\tt FK} grid is defined, given as an $N_x$ long list of the $x$-grid points. This grid should be optimised to minimise {\tt FK} grid zeros in $x$-space. Here is an example of an $x$-grid with $N_x=5$ entries:
\begin{quotation}\noindent
"NNPDFgrid"\\
 0.10000000000000001     \\
  0.13750000000000001     \\
  0.17499999999999999     \\
  0.21250000000000002     \\
  1.00000000000000000     
\end{quotation}
This grid ends the preamble. For examples of complete DIS and hadronic {\tt FK} table headers, see Appendix~\ref{app:FKheaders}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsubsection*{{\tt FK} grid layout}
To start the section of the file with the {\tt FK} grid itself, we begin with a header line
\begin{quotation}\noindent
"FKGrid"
\end{quotation}
The grid itself is now written out. For hadronic data, the format is line by line as follows:
\be d \:\: \alpha \:\: \beta \:\: \sigma^d_{\alpha\beta 1 1} \:\: \sigma^d_{\alpha\beta 1 2}\:\: ....\:\: \sigma^d_{\alpha\beta n n} \ee
Where $d$ is the index of the data point for that line, $\alpha$ is the x-index of the first PDF, $\beta$ is the x-index of the second PDF, the $\sigma^d_{\alpha\beta i j}$ are the values of the FastKernel grid for data point $d$ as in Eqn~\ref{eq:FKprod}, and $n=14$ is the total number of parton flavours in the grid. Therefore the full $14\times 14$ flavour space for one combination of the indices $\{d,\alpha,\beta\}$ is written out on each line. 

These lines should be written out first in $\beta$, then $\alpha$ and finally $d$ so that the {\tt FK} grids are written in blocks of datapoints. All {\tt FK} grid values should be written out in double precision. For DIS data the {\tt FK} grids must be written out as
\be d \:\: \alpha \:\: \sigma^d_{\alpha 1} \:\: \sigma^d_{\alpha 2}\:\: ....\:\: \sigma^d_{\alpha n} \ee
Therefore here all $n=14$ values are written out for each combination of $\{d,\alpha\}$.

When writing out the grids, note that only $x$-grid points for which there are nonzero {\tt FK} entries are written out. For example, there should be no lines such as:
\begin{quotation} d \:\: $\alpha$ \:\: $\beta$ \:\:  0 \:\: 0      \:\:                 0    \:\:  ... \:\: 0  \end{quotation}
However, for those $x$-grid points which do have nonzero $\sigma$ contributions, the full set of flavour contributions must be written out regardless of the number of zero entries. This choice was made in order that the nonzero flavour entries may be examined/optimised by hand after the FK table is generated.

The {\tt FK} file should end on the last entry in the grid, and without empty lines at the end of file.

\subsection{{\tt CFACTOR} file format}
Additional multiplicative factors to be applied to the output of the {\tt FK} convolution may be introduced by the use of {\tt CFACTOR} files. These files have a very simple format. The first lines give a description of the $C$-factor information stored in the file. This segment is initialised and terminated by a line beginning with a star (\mbox{*}) character and consists of six mandatory fields
\begin{itemize}
\item \textbf{SetName} - The \emph{Dataset} name.
\item \textbf{Author} - The author of the {\tt CFACTOR} file.
\item \textbf{Date} - The date of authorship.
\item \textbf{CodesUsed} - The code or codes used in generating the $C-$factors.
\item \textbf{TheoryInput} - Theory input parameters used in the $C-$factors (e.g $\alpha_S$, scales).
\item \textbf{PDFset} - The PDF set used in the $C-$factors.
\end{itemize}
These fields are formatted as 
\begin{quotation}
FieldName: FieldEntry
\end{quotation}
and may be accompanied by any additional information, within the star delineated header region. Consider the following as a complete example of the header,
\begin{quotation}\noindent
*******************************************\\
SetName: D0ZRAP\\
Author: John Doe john.doe@cern.ch \\
Date: 2014\\
CodesUsed: MCFM 15.01\\
TheoryInput: as 0.118, central scale 91.2 GeV\\
PDFset: NNPDF30\_as\_0118\_nnlo\\
Warnings: None\\
Additional Information here\\
*******************************************
\end{quotation}
The remainder of the file is simply given by the $C$-factors themselves, with the $C$-factor for each datapoint being given line by line. For example, for \emph{Dataset} with five points, the data section of a {\tt CFACTOR} file may be:
\begin{quotation}\noindent
 1.1\\
 1.2\\
 1.3\\
 1.4\\
 1.5
\end{quotation}
Where the $i^{\text{th}}$ line corresponds to the $C$-factor to be applied to the {\tt FK} prediction for the $(i-1)^{\text{th}}$ datapoint.
For a complete example of a {\tt CFACTOR} file, please see Appendix~\ref{app:CFACexa}.

\subsection{{\tt COMPOUND} file format}
Some \emph{Datasets} cover observables that depend nonlinearly upon the input PDFs. For example, the NMCPD \emph{Dataset} is a measurement of the ratio of deuteron to proton structure functions. In the {\tt nnpdf++} code such sets are denoted \emph{Compound Datasets}. In these cases, a prescription for how the results from FK convolutions as in Eqn~\ref{eq:FKprod} should be combined must be given. 

The {\tt COMPOUND} files are a simple method of providing this information. For each \emph{Compound Dataset} a {\tt COMPOUND} file is provided that contains the information on how to build the observable from constituent {\tt FK} tables. The following operations are currently implemented.
\begin{table}[htp]
\begin{center}
\begin{tabular}{|l|c|l|}
\hline
Operation $(N_{\text{\tt FK}})$ & Code & Output Observable\\
\hline\hline
Null Operation(1)& \textbf{NULL} &  $\mathcal{O}_d =  \mathcal{O}_d^{(1)}$ \\
Sum (2)& \textbf{ADD} &  $\mathcal{O}_d = \mathcal{O}^{(1)}_d + \mathcal{O}^{(2)}_d $\\
Normalised Sum (4)&  \textbf{SMN}  & $\mathcal{O}_d = (\mathcal{O}^{(1)}_d + \mathcal{O}^{(2)}_d)/(\mathcal{O}^{(3)}_d + \mathcal{O}^{(4)}_d) $ \\
Asymmetry (2)& \textbf{ASY} &  $\mathcal{O}_d = (\mathcal{O}^{(1)}_d - \mathcal{O}^{(2)}_d)/(\mathcal{O}^{(1)}_d + \mathcal{O}^{(2)}_d) $\\
Ratio (2)&  \textbf{RATIO} & $\mathcal{O}_d = \mathcal{O}^{(1)}_d / \mathcal{O}^{(2)}_d $\\
\hline
\end{tabular}
\end{center}
\label{default}
\end{table}%

Here $N_{\text{\tt FK}}$ refers to the number of tables required for each compound operation. $\mathcal{O}_d$ is final observable prediction for the $d^{\text{th}}$ point in the \emph{Dataset}. $\mathcal{O}_d^{(i)}$ refers to the observable prediction for the $d^{\text{th}}$ point arising from the $i^{\text{th}}$ {\tt FK} table calculation. Note that here the ordering in $i$ is important.

The {\tt COMPOUND} file layout is as so. The first line is once again a general comment line and is not used by the code, and therefore has no particular requirements other than its presence. Following this line should come a list of the {\tt} FK tables required for the calculation. This must be given as the table's filename \emph{without} its path, preceded by the string `\textbf{FK: }'. For example,

\begin{quotation}\noindent
FK: FK\_SETNAME\_1.dat\\
FK: FK\_SETNAME\_2.dat
\end{quotation}

The ordering of the list is once again important, and must match the above table. For example the observables $\mathcal{O}^{(i)}$ arise from the computation with the $i^{\text{th}}$ element of this list. The final line specified the operation to be performed upon the list of tables, and must take the form

\begin{quotation}\noindent
OP: \textbf{[CODE]}
\end{quotation}
where the \textbf{[CODE]} is given in the above table. Here is an example of a complete {\tt COMPOUND} file

\begin{quotation}\noindent
\# COMPOUND FK\\
FK: FK\_NUMERATOR.dat\\
FK: FK\_DENOMINATOR.dat\\
OP: RATIO
\end{quotation}

\clearpage
\section{Organisation of data files} \label{sec:org}
The {\tt nnpdf++} code needs to be able to handle a great deal of different options with regard to the treatment of both experimental data
and theoretical choices. In the code, every effort has been made to keep experimental and theoretical parameters strictly separate.

In this section we shall specify the layout of the {\tt nnpdf++} data directory. It is in this directory that all of the read-only data to be used in
the fit are accessed. The data directory path is typically supplied to the core code by way of the compile time macro {\tt DATA\_PATH} which is by default set to {\tt data} in the trunk root directory. However the user may change this to specify a custom data directory location.
\subsection{Experimental data storage}
The central repository for {\tt CommonData} in use by {\tt nnpdf++} projects is located in the {\tt nnpdf++} svn at
\begin{quotation}
    {\tt /nnpdfcpp/trunk/data/commondata/}
\end{quotation}
Where a separate {\tt CommonData} file is stored for each {\it Dataset} with the filename format
\begin{quotation}
	{\tt DATA\_<SETNAME>.dat }
\end{quotation}
Information on the treatment of systematic uncertainties, provided in {\tt SYSTYPE} files, are located in the subdirectory
\begin{quotation}
    {\tt /nnpdfcpp/trunk/data/commondata/systypes}
\end{quotation}
Here several {\tt SYSTYPE} files may be supplied for each {\it Dataset}. The various options are enumerated by an integer suffix to the filename. The filename format for {\tt SYSTYPE} files is therefore
\begin{quotation}
	{\tt SYSTYPE\_<SETNAME>\_<SYSID>.dat }
\end{quotation}
As an example, consider the first {\tt SYSTYPE} file for the D0ZRAP {\it Dataset}:
\begin{quotation}
	{\tt SYSTYPE\_D0ZRAP\_0.dat }
\end{quotation}
In addition to the {\tt SYSTYPE} files, this directory also includes files containing a description of each treatment of systematic errors. They have the filename format
\begin{quotation}
	{\tt SYSTYPES\_<SETNAME>.info }
\end{quotation}
and have no particular layout, but must enumerate and give a brief explanation for all of the possible systematics treatments for the associated {\it Dataset}. For example, here is the info file for the D0ZRAP systypes:
\begin{quotation}\noindent
\# SYSTYPES.info : SysType options description.\\
\# Please fill this in when you add a new SysType Option\\
\\
1: NNPDF2.3 Standard (Default)\\
2: All systematic uncertainties assumed to be multiplicative\\
3: All systematic uncertainties assumed to be additive\\
4: Baseline Standard (Collider data: All systematics random)
\end{quotation}

\subsection{Theory lookup table}
In order to organise the various different theoretical treatments available, a lookup table
is provided in {\tt sqlite3} format. This lookup table can be found in the {\tt nnpdf++} main data directory in the svn:
\begin{quotation}
    {\tt /nnpdfcpp/trunk/data/theory.db}
\end{quotation}
This file should only be edited in order to add new theory options. It may be edited with any appropriate sqlite3-supported software. A script is provided to give a brief overview of the various theory options available. It can be found at
\begin{quotation}
    {\tt /nnpdfcpp/trunk/data/disp\_theory.py}
\end{quotation}
and should be run without any arguments.
\\\\
Theory options are enumerated by an integer {\it TheoryID}. The parameters of each theory option are described in the lookup table under the appropriate ID. The current available parameters are summarised in Table~\ref{tab:theoryparams}.

\subsection{Theory storage}

Each theory configuration is stored as a GZIP compressed Tar archive with filename format
\begin{quotation}
    {\tt theory\_<THEORYID>.tgz}
\end{quotation}
and are stored at
\begin{quotation}
    {\tt pcteserver.mi.infn.it:/home/apfelcomb/WEB/commondatatheory/}
\end{quotation}
For easy access, they can be downloaded through the {\tt disp\_theory.py} script mentioned above, or through the web interface at

\begin{quotation}
    \url{http://pcteserver.mi.infn.it/~apfelcomb/fkviewer/}
\end{quotation}

Each archive contains the following directory structure
\begin{quotation}\noindent
{\tt
theory\_X/ \\
\-\hspace{1cm}-cfactor/\\
\-\hspace{1cm}-compound/\\
\-\hspace{1cm}-fastkernel/\\
}
\end{quotation}
Inside the directory {\tt theory\_X/cfactor/} are stored {\tt CFACTOR} files with the filename format
\begin{quotation}\noindent
{\tt CF\_<TYP>\_<SETNAME>.dat }
\end{quotation}
where {\tt<TYP>} is a three-letter designation for the source of the C-factor (i.e EWK or QCD) and {\tt<SETNAME>} is the typical {\it Dataset} designation. \\\\
The directory {\tt theory\_X/compound/} contains the {\tt COMPOUND} files described earlier, this time with the filename format
\begin{quotation}\noindent
{\tt FK\_<SETNAME>-COMPOUND.dat }
\end{quotation}
Finally the {\tt FK} tables themselves are stored in {\tt theory\_X/fastkernel/} with the filename format
\begin{quotation}\noindent
{\tt FK\_<SETNAME>.dat }
\end{quotation}
Naturally, all of the FastKernel and C-factor files within the directory {\tt theory\_X/} have been determined with the theoretical parameters specified in the theory lookup table under ID {\tt X}.
\\\\
For use in the {\tt nnpdf++} code, these theory archives should be uncompressed in the relevant
data directory. The code then may switch between different theory settings by using the relevant files from the relevant theory directory.

\begin{table}[htp]
\begin{center}
\begin{tabular}{|r|l|l|p{50mm}|}
\hline
Field       & Type    & Description                    & Comments \\
\hline\hline
  ID        & Integer & \it TheoryID                   &  Theory enumerating ID \\
  PTO       & Integer & pQCD order                     & (0/1/2 = LO/NLO/NNLO) \\
  FNS       & Text    & Flavour Number Scheme          & e.g FONLL-A/B/C \newline or ZM-VFNS or FFNS \\
  DAMP      & Integer & FONLL damping factor switch    & Boolean \\
  IC        & Integer & Intrinsic charm switch         & Boolean \\
  ModEv     & Text    & DGLAP solution mode            & EXA/EXP/TRN \\
  XIR       & Real    & $\xi_R$                        & $\mu_R/Q$ \\
  XIF       & Real    & $\xi_F$                        & $\mu_F/Q$ \\
  NfFF      & Integer & Number of flavours in the FFNS & 3/4/5/6 \\
  MaxNfAs   & Integer & $n_{f,\rm max}^{(\alpha_S)}$        & Max active flavours in $\alpha_s$ \\
  MaxNfPdf  & Integer & $n_{f,\rm max}^{(\rm PDF)}$         & Max active flavours in PDFs \\
  Q0        & Real    & $Q_0$                          & FK Table initial scale \\
  alphas    & Real    & Strong coupling                & Format: $\alpha_S(Q_{\textbf{ref}})$ \\
  Qref      & Real    & $Q_{\textbf{ref}}$                & Reference scale for $\alpha_S$ in GeV \\
  QED       & Integer & QED switch                     & Boolean \\
  alphaqed  & Real    & QED coupling                   & Format: $\alpha_{\mathrm{QED}}(Q_{\textbf{qedref}})$ \\
  Qedref    & Real    & $Q_{\textbf{qedref}}$              & QED reference scale (GeV) \\
  SxRes     & Integer & small-$x$ resummation switch   & Boolean \\
  SxOrd     & Text    & small-$x$ pt order             & (``LL'', ``NLL'', ``NNLL'') \\
  HQ        & Text    & HQ mass treatment              & POLE/MSBAR \\
  mc        & Real    & $c$ quark mass $M_c/m_c(Q_{\mathrm{mc}})$   & Units: GeV \\
  Qmc     & Real    & $Q_{\mathrm{mc}}$ & $c$ reference scale (GeV)\\
  mb        & Real    & $b$ quark mass $M_b/m_b(Q_{\mathrm{mb}})$   & Units: GeV \\
  Qmb     & Real    & $Q_{\mathrm{mb}}$ & $b$ reference scale (GeV)\\
  mt        & Real    & $t$ quark mass $M_t/m_t(Q_{\mathrm{mt}})$   & Units: GeV \\
  Qmt     & Real    & $Q_{\mathrm{mt}}$ & $t$ reference scale (GeV)\\
  CKM       & Text    & CKM matrix elements & 3X3 matrix \\
  MZ        & Real    & $M_Z$                          & $Z$ mass (GeV) \\
  MW        & Real    & $M_W$                          & $W$ mass (GeV) \\
  GF        & Real    & $G_F$                          & Fermi coupling constant \\
  SIN2TW    & Real    & $\sin^2\theta_W$               & \\
  TMC       & Integer & Target mass corrections        & Boolean \\
  MP        & Real    & $M_P$ Proton mass              & Units: GeV \\
  Comments  & Text    & General comments               & \\               
\hline
\end{tabular}
\caption{Table describing the contents and required parameters of the {\tt theory.db} lookup table. The Type column refers directly to the {\tt sqlite3} data type of the field.}\label{tab:theoryparams}
\end{center}
\end{table}%


\clearpage
\appendix
\section{{\tt CFACTOR} file format example} \label{app:CFACexa}
\begin{quotation}\noindent
*******************************************\\
SetName: D0ZRAP\\
Author: John Doe john.doe@cern.ch \\
Date: 2014\\
CodesUsed: MCFM 15.01\\
TheoryInput: as 0.118, central scale 91.2 GeV\\
PDFset: NNPDF30\_as\_0118\_nnlo\\
Warnings: None\\
7 datapoints in total. 
No smoothing applied\\
*******************************************\\
 1.1\\
 1.2\\
 1.3\\
 1.4\\
 1.5\\
 1.6\\
 1.7 \\
\end{quotation}
\clearpage
\section{{\tt FK} preamble examples} \label{app:FKheaders}
\subsection{DIS preamble - BCDMSD}

\begin{quotation}\noindent
  '-------------------------------'\\
  ' FK\_BCDMSD.dat '\\
  '-------------------------------'\\
 'ndata    nx'\\
           254            50\\
 "process ptord"\\
 DIS N2LO\\
 "flavourmap"\\
            0           1           1           0           0           0           0           0           0           0           1           0           0           0 \\
 "q0"\\
   1.0000000000000000     \\
 "FNS Modev nf"\\
 FONLL-C    TRN               5\\
 "alphas qref"\\
 0.118   91.200000000000003     \\
 "mass mc, mb, mt"\\
 POLE    1.2749999999999999        4.1799999999999997        173.06999999999999     \\
 "QED alphaqed qref"\\
 OFF   7.4962520000000001E-003   1.7769999999999999     \\
 "NNPDFgrid"\\
   9.9999999999999995E-008\\
   1.7378008287493754E-007\\
   3.0199517204020160E-007\\
   5.2480746024977254E-007\\
   9.1201083935590974E-007\\
   1.5848931924611137E-006\\
   2.7542287033381659E-006\\
   4.7863009232263851E-006\\
   8.3176377110267111E-006\\
   1.4454397707459272E-005\\
   2.5118864315095808E-005\\
   4.3651583224016600E-005\\
   7.5857757502918358E-005\\
   1.3182567385564074E-004\\
   2.2908676527677748E-004\\
   3.9810717055349714E-004\\
   6.9183097091893666E-004\\
   1.2022644346174139E-003\\
   2.0892961308540386E-003\\
   3.6307805477010144E-003\\
   6.3095734448019372E-003\\
   1.0964781961431845E-002\\
   1.9054607179632473E-002\\
   3.3113112148259127E-002\\
   5.7543993733715673E-002\\
  0.10000000000000001     \\
  0.13750000000000001     \\
  0.17499999999999999     \\
  0.21250000000000002     \\
  0.25000000000000000     \\
  0.28749999999999998     \\
  0.32500000000000001     \\
  0.36250000000000004     \\
  0.40000000000000002     \\
  0.43750000000000000     \\
  0.47499999999999998     \\
  0.51250000000000007     \\
  0.55000000000000004     \\
  0.58750000000000002     \\
  0.62500000000000000     \\
  0.66249999999999998     \\
  0.69999999999999996     \\
  0.73750000000000004     \\
  0.77499999999999991     \\
  0.81250000000000000     \\
  0.84999999999999998     \\
  0.88750000000000007     \\
  0.92500000000000004     \\
  0.96249999999999991     \\
   1.0000000000000000 
\end{quotation}

\clearpage
\subsection{Hadronic preamble - CDFR2KT}

\begin{quotation}\noindent
 -----------------------------------------------------------\\
 FK\_CDFR2KT.dat\\
 -----------------------------------------------------------\\
"ndata nx"\\
76  50\\
"hadronic ptord"\\
HAD N2LO\\
"flavourmap"\\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 1 1 0 0 0 0 0 0 0 0 0 0 0 \\
0 1 1 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 1 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 1 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 1 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 1 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 1 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0 \\
0 0 0 0 0 0 0 0 0 0 0 0 0 0\\
"q0"\\
1\\
"FNS Modev NF"\\
FONLL-C  TRN 5\\
"alphas qref"\\
0.118  91.2\\
"mass mc, mb, mt"\\
POLE  1.275  4.18  173.07\\
"QED alphaqed qref"\\
 OFF 0 0 \\
"NNPDFgrid"\\
1e-07\\
1.73780082874938e-07\\
3.01995172040202e-07\\
5.24807460249773e-07\\
9.1201083935591e-07\\
1.58489319246111e-06\\
2.75422870333817e-06\\
4.78630092322639e-06\\
8.31763771102671e-06\\
1.44543977074593e-05\\
2.51188643150958e-05\\
4.36515832240166e-05\\
7.58577575029184e-05\\
0.000131825673855641\\
0.000229086765276777\\
0.000398107170553497\\
0.000691830970918937\\
0.00120226443461741\\
0.00208929613085404\\
0.00363078054770101\\
0.00630957344480194\\
0.0109647819614318\\
0.0190546071796325\\
0.0331131121482591\\
0.0575439937337157\\
0.1\\
0.1375\\
0.175\\
0.2125\\
0.25\\
0.2875\\
0.325\\
0.3625\\
0.4\\
0.4375\\
0.475\\
0.5125\\
0.55\\
0.5875\\
0.625\\
0.6625\\
0.7\\
0.7375\\
0.775\\
0.8125\\
0.85\\
0.8875\\
0.925\\
0.9625\\
1
\end{quotation}

\clearpage
\begin{thebibliography}{1}
%\cite{Aad:2011fc}
\bibitem{Aad:2011fc}
  G.~Aad {\it et al.}  [ATLAS Collaboration],
  %``Measurement of inclusive jet and dijet production in $pp$ collisions at $\sqrt{s}=7$ TeV using the ATLAS detector,''
  Phys.\ Rev.\ D {\bf 86} (2012) 014022
  [arXiv:1112.6297 [hep-ex]].
  %%CITATION = ARXIV:1112.6297;%%
  %164 citations counted in INSPIRE as of 27 Jan 2015
  
  %\cite{Aad:2013iua}
\bibitem{Aad:2013iua}
  G.~Aad {\it et al.}  [ATLAS Collaboration],
  %``Measurement of the high-mass Drell--Yan differential cross-section in pp collisions at sqrt(s)=7 TeV with the ATLAS detector,''
  Phys.\ Lett.\ B {\bf 725} (2013) 223
  [arXiv:1305.4192 [hep-ex]].
  %%CITATION = ARXIV:1305.4192;%%
  %36 citations counted in INSPIRE as of 27 Jan 2015

\end{thebibliography}

\end{document} 
