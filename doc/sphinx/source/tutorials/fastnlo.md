# How to generate fastNLO tables
*Author: Rabah Abdul Khalek*

Similar to the `applgrids` introduced in [How to generate APPLgrids](APPLgrids.md), `fastNLO tables` are the partonic cross sections needed to compute hadronic observables (proton-proton collisions).
These QCD-perturbative components are generated by `Monte-Carlo` simulation and tabulated in `.dat` format.
`MCFM-6.8` is used to generate a variety of non-jet processes in NNPDF, therefore `fastNLO` interfaced with `nlojet` are used for the jet ones.

## Installing fastNLO
To install the whole interface, one needs the following packages:
- `LHAPDF.6.2.3` is a general purpose python/C++ interpolator, used for evaluating PDFs from discretised data files.
- `hoppet-1.1.5` is a Higher Order Perturbative Parton Evolution Toolkit
- `FastJet-3.1.3` is a library containing all definition of jet algorithms and library invoked by NLOJet.
- `NLOJet-4.1.3-patched` is the equivalent of `MCFM-6.8`, the MC generator.
- `fastnlo-toolkit 2585` is a kit that allows to manipulate fastnlo tables.
- `fastnlo_interface_nlojet-2.3.1 (pre-2411)` is the equivalent of `mcfm-bridge-0.0.34-nnpdf`.
check: https://fastnlo.hepforge.org

Please follow the order to install the packages correctly.

### Setting up your conda env

Start by creating an environement:
```
conda create fastnlo
conda activate fastnlo
```

Note: Before following the manual installation of the packages, try the following:
```
conda install fastnlo
```
or 
```
conda install fastjet
```

### Installing `LHAPDF.6.2.3`
Note: for now, `conda install LHAPDF` although it installs `LHAPDF.6.2.3` but doesn't work with the rest of the softwares
```
wget https://lhapdf.hepforge.org/downloads/?f=LHAPDF-6.2.3.tar.gz
tar -xzvf LHAPDF-6.2.3.tar.gz
./configure --prefix=$CONDA_PREFIX
make && make install
``` 

### Installing `FastJet-3.1.3`
``` 
wget https://fastnlo.hepforge.org/code/other/fastjet-3.1.3.tar.gz
tar -zxvf fastjet-3.1.3.tar.gz 
./configure --prefix=$CONDA_PREFIX --bindir=$CONDA_PREFIX/bin --enable-shared --enable-allplugins 
make -j 4 && make test && make install 
```

### Installing `NLOJet-4.1.3-patched`
```
wget https://fastnlo.hepforge.org/code/other/nlojet++-4.1.3-patched.tar.gz 
./configure --prefix=$CONDA_PREFIX 
make -j 4 && make install 
```

### Installing `fastnlo-toolkit 2585`
``` 
wget https://fastnlo.hepforge.org/code/v23/fastnlo_toolkit-2.3.1-2585.tar.gz 
tar -zxvf fastnlo_toolkit-2.3.1-2585.tar.gz 
./configure --prefix=$CONDA_PREFIX 
make -j 4  && make install 
```

### Installing `hoppet-1.1.5`
`hoppet-1.1.5` can be found in the `NNPDF/external`, to install it:
```
cd external/hoppet/hoppet-1.1.5
./configure --prefix=$CONDA_PREFIX 
make -j 4 && make install 
```

### Installing `fastnlo_interface_nlojet-2.3.1 (pre-2411)`
 ```
 ./configure --prefix=$CONDA_PREFIX --with-hoppet  
 make -j 4 && make install  
 ```

## Producing `fastNLO` tables

Similar to the implementation of bins in `mcfm-bridge-0.0.34-nnpdf`, one needs to do the same in `fastnlo_interface_nlojet-2.3.1`:
1. go to `fastnlo_interface_nlojet-2.3.1/interface/hadron/`.
2. Edit a new .cc file corresponding to a new analysis, e.g CMS_2JET_7TEV.cc (see JETS branch in `NNPDF/external`).
3. look first at `InclusiveNJets_new.cc` to learn about the code.
  
Two files are actually needed: the `.cc` file and the `steering` file: 
- One needs to change the .cc file only in three cases: define observable, variable not defined, or change scale choice. Note: edit accordingly the Makefile.in in fastnlo_interface_nlojet-2.3.1/interface and compile again the interface
- As for the steering file: this is where all the kinematic cuts and binning are defined
  
Once the `.cc` file and the `steering` file are set, you need to run twice (similarly to mcfm):

- 1st:
```
bin/nlojet++ --calculate -cnlo --max-event=100000000 -n taskname [-s randomseed]
             -u lib/fastnlo_interface_nlojet/libInclusiveJets.la
```

- 2nd:
loop over 100 born jobs and 500 nlo jobs 1 billion events each (each job between 5 and 10 hours)
```
bin/nlojet++ --calculate -c[born|nlo] [--max-event=nnnnnnn] [-n taskname] [-s randomseed]
             -u lib/fastnlo_interface_nlojet/libInclusiveJets.la
```

Notes regarding the run:
- for benchmarking purposes use only born for 100 jobs 1 billion each)
- taskname to be iterated over.
- randomseed to be iterated over

Notes regarding the output:
- store fastNLO tables in NNPDF/applgrids (after combining them)
- git pull master to get the new applgrids with fastnlo tables and recombiple apfelcomb

Notes regarding the scale choice:
- For inclusive jet: the factorization scale is relevant : H_T is more suited than p_T where (NNLO-NLO)_H_T < (NNLO-NLO)_p_T
- For dijets: itâ€™s not as relevant.